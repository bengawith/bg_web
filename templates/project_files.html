{% extends "base.html" %}

{% block title %}{{ repo_name }} Files{% endblock %}

{% block content %}
<h1>{{ repo_name }}</h1>

<!-- Breadcrumb Navigation -->
<nav class="breadcrumb">
    {% for crumb in breadcrumbs %}
        <a href="{{ crumb.path }}">{{ crumb.name }}</a> {% if not loop.last %} > {% endif %}
    {% endfor %}
</nav>

<p>Explore the files:</p>

<ul class="file-tree">
    {% for file in files %}
        <li>
            {% if file.type == "dir" %}
                <details class="folder">
                    <summary data-path="{{ file.path }}">ðŸ“‚ <strong>{{ file.name }}</strong></summary>
                    <ul class="nested-files"></ul>
                </details>
            {% else %}
                ðŸ“„ <a href="{{ url_for('view_file', repo_name=repo_name, file_path=file.path) }}">{{ file.name }}</a>
            {% endif %}
        </li>
    {% endfor %}
</ul>

<style>
    .file-tree {
        list-style-type: none;
        padding-left: 20px;
    }

    .file-tree li {
        padding: 5px;
        font-size: 1.1rem;
    }

    .file-tree details {
        margin-bottom: 8px;
    }

    .file-tree summary {
        cursor: pointer;
        font-weight: bold;
        color: #8e2de2;
    }

    .file-tree a {
        color: #8e2de2;
        text-decoration: none;
        font-weight: bold;
    }

    .file-tree a:hover {
        text-decoration: underline;
    }

    /* Breadcrumbs */
    .breadcrumb {
        margin-bottom: 10px;
        font-size: 1.1rem;
    }

    .breadcrumb a {
        text-decoration: none;
        color: #4a00e0;
        font-weight: bold;
    }

    .breadcrumb a:hover {
        text-decoration: underline;
    }
</style>

<script>
    document.querySelectorAll(".folder summary").forEach(folder => {
        folder.addEventListener("click", async function (event) {
            event.preventDefault(); // Prevents default expand behavior
            
            const folderPath = this.dataset.path;
            const nestedList = this.nextElementSibling;

            // If files are already loaded, just toggle visibility
            if (nestedList.innerHTML.trim() !== "") {
                nestedList.classList.toggle("hidden");
                return;
            }

            // Fetch files dynamically
            const response = await fetch(`/project/{{ repo_name }}/${folderPath}`);
            const parser = new DOMParser();
            const doc = parser.parseFromString(await response.text(), "text/html");
            const newFiles = doc.querySelector(".file-tree").innerHTML;

            nestedList.innerHTML = newFiles; // Inject new files into the folder
        });
    });
</script>

{% endblock %}
